<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jarvis Voice Console</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-primary: #090e1a;
        --bg-secondary: linear-gradient(145deg, #0d1322, #060910);
        --accent: #4ade80;
        --accent-soft: rgba(74, 222, 128, 0.12);
        --accent-strong: #22c55e;
        --card-bg: #0f172a;
        --card-shadow: 12px 12px 24px rgba(0, 0, 0, 0.45), -8px -8px 18px rgba(36, 54, 86, 0.45);
        --border-soft: rgba(148, 163, 184, 0.12);
        --text-soft: #94a3b8;
        --text-strong: #e2e8f0;
        --danger: #f87171;
        --warning: #facc15;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "SF Pro Display", "Segoe UI", sans-serif;
        background: var(--bg-secondary);
        color: var(--text-strong);
        display: flex;
        justify-content: center;
      }

      .app-shell {
        width: 100%;
        max-width: 1400px;
        display: flex;
        gap: 24px;
        padding: 32px;
      }

      .control-panel {
        width: 320px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .skeuo-card {
        background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.05), rgba(15, 23, 42, 0.92));
        border: 1px solid var(--border-soft);
        border-radius: 18px;
        padding: 18px;
        box-shadow: var(--card-shadow);
        backdrop-filter: blur(12px);
      }

      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .brand span {
        font-size: 0.8rem;
        color: var(--accent);
        background: var(--accent-soft);
        padding: 4px 8px;
        border-radius: 999px;
      }

      label.section-title {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-soft);
        margin-bottom: 8px;
      }

      select, button {
        font: inherit;
      }

      select.app-select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-strong);
        box-shadow: inset 2px 2px 6px rgba(0, 0, 0, 0.45);
      }

      .voice-card-stack {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .voice-card {
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.16);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.5), inset -4px -4px 8px rgba(56, 78, 110, 0.25);
      }

      .voice-card h3 {
        margin: 0;
        font-size: 0.95rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .voice-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .voice-controls button {
        border: 0;
        border-radius: 10px;
        padding: 6px 12px;
        cursor: pointer;
        transition: transform 0.15s ease;
      }

      .voice-controls button:hover {
        transform: translateY(-1px);
      }

      .btn-preview-en {
        background: rgba(37, 99, 235, 0.8);
        color: #dbeafe;
      }

      .btn-preview-hi {
        background: rgba(147, 51, 234, 0.8);
        color: #ede9fe;
      }

      .btn-save-voice {
        background: rgba(34, 197, 94, 0.85);
        color: #ecfdf5;
        margin-left: auto;
      }

      .agent-monitor, .system-usage, .tts-history {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .agent-steps {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 220px;
        overflow-y: auto;
      }

      .agent-step {
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
      }

      .agent-step .status {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 999px;
      }

      .status-running { background: rgba(59, 130, 246, 0.18); color: #bfdbfe; }
      .status-complete { background: rgba(34, 197, 94, 0.18); color: #bbf7d0; }
      .status-error { background: rgba(248, 113, 113, 0.18); color: #fecaca; }
      .status-applied { background: rgba(250, 204, 21, 0.18); color: #fef08a; }
      .status-queued { background: rgba(148, 163, 184, 0.18); color: #e2e8f0; }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .pill {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.2);
        font-size: 0.8rem;
      }

      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .top-strip {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-pill, .timer-pill {
        padding: 10px 16px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.16);
        box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.35), inset -3px -3px 6px rgba(54, 78, 110, 0.25);
        font-weight: 500;
      }

      .pill-select {
        display: flex;
        align-items: center;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.16);
        background: rgba(15, 23, 42, 0.8);
        box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.35), inset -3px -3px 6px rgba(54, 78, 110, 0.25);
      }

      .pill-select select {
        appearance: none;
        border: 0;
        background: transparent;
        color: var(--text-strong);
        padding: 10px 18px;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .pill-select select:focus {
        outline: none;
      }

      .admin-button {
        padding: 8px 14px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.16);
        background: rgba(15, 23, 42, 0.85);
        color: var(--text-soft);
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .admin-button:hover {
        background: rgba(59, 130, 246, 0.2);
        color: #bfdbfe;
      }

      .ring-section {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
      }

      .ring {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.06), rgba(15, 23, 42, 0.95));
        border: 2px solid rgba(148, 163, 184, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 8px 8px 18px rgba(0, 0, 0, 0.55), inset -6px -6px 16px rgba(59, 130, 246, 0.18);
        cursor: pointer;
        transition: box-shadow 0.2s ease;
      }

      .ring.active {
        box-shadow: inset 12px 12px 30px rgba(0, 0, 0, 0.6), inset -10px -10px 28px rgba(74, 222, 128, 0.25), 0 0 45px rgba(74, 222, 128, 0.25);
      }

      .ring.manual {
        box-shadow: inset 12px 12px 30px rgba(0, 0, 0, 0.6), inset -10px -10px 28px rgba(59, 130, 246, 0.35);
      }

      .ring.speaking {
        box-shadow: inset 12px 12px 30px rgba(0, 0, 0, 0.6), inset -10px -10px 28px rgba(250, 204, 21, 0.25), 0 0 45px rgba(250, 204, 21, 0.2);
      }

      .audio-meter {
        width: 60%;
        height: 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.2);
        overflow: hidden;
        box-shadow: inset 2px 2px 6px rgba(0, 0, 0, 0.45);
      }

      .audio-meter-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #22d3ee, #4ade80);
        transition: width 0.12s ease;
      }

      .live-transcript {
        min-height: 28px;
        font-size: 1rem;
        color: var(--accent);
        letter-spacing: 0.02em;
      }

      .voice-banner {
        padding: 12px 16px;
        border-radius: 14px;
        background: rgba(37, 99, 235, 0.12);
        border: 1px solid rgba(37, 99, 235, 0.25);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
        backdrop-filter: blur(10px);
      }

      .voice-banner span.label {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.7rem;
        color: #bfdbfe;
      }

      .system-tags {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .planner-card {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
      }

      .planner-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .planner-header h2 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .planner-header .mode-label {
        display: block;
        font-size: 0.75rem;
        color: var(--accent);
        letter-spacing: 0.05em;
      }

      .mode-buttons {
        display: flex;
        gap: 6px;
      }

      .mode-buttons button {
        border: 0;
        border-radius: 10px;
        padding: 6px 12px;
        cursor: pointer;
        background: rgba(15, 23, 42, 0.7);
        color: var(--text-soft);
        transition: background 0.2s ease, color 0.2s ease;
      }

      .mode-buttons button.active {
        background: rgba(74, 222, 128, 0.16);
        color: #bbf7d0;
      }

      .whats-next {
        font-size: 0.9rem;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(59, 130, 246, 0.12);
        border: 1px solid rgba(59, 130, 246, 0.18);
      }

      .calendar-timeline {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 280px;
        overflow-y: auto;
      }

      .timeline-block {
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.16);
      }

      .timeline-block .time {
        font-size: 0.8rem;
        color: var(--text-soft);
      }

      .timeline-block .title {
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .timeline-block .meta {
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.75);
      }

      .timeline-block.event {
        border-left: 3px solid rgba(59, 130, 246, 0.65);
      }

      .timeline-block.focus {
        border-left: 3px solid rgba(34, 197, 94, 0.65);
      }

      .timeline-block.prep {
        border-left: 3px solid rgba(250, 204, 21, 0.65);
      }

      .planner-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .planner-actions button {
        border: 0;
        border-radius: 10px;
        padding: 8px 14px;
        background: rgba(74, 222, 128, 0.12);
        color: var(--accent);
        cursor: pointer;
      }

      .planner-privacy {
        margin: 0;
        font-size: 0.75rem;
        color: var(--text-soft);
      }

      .chat-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .chat-log {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding-right: 6px;
      }

      .chat-message {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.12);
        box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.4), inset -3px -3px 6px rgba(59, 130, 246, 0.18);
      }

      .chat-message.user {
        align-self: flex-end;
        background: rgba(34, 197, 94, 0.12);
        border-color: rgba(34, 197, 94, 0.32);
      }

      .chat-message.assistant {
        border-color: rgba(59, 130, 246, 0.28);
      }

      .chat-message.transcript {
        border-style: dashed;
        border-color: rgba(250, 204, 21, 0.28);
      }

      .chat-message span {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-soft);
      }

      .chat-message p {
        margin: 0;
        line-height: 1.5;
      }

      .chat-form {
        display: flex;
        gap: 12px;
      }

      .chat-form input {
        flex: 1;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text-strong);
        box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.45);
      }

      .chat-form button {
        padding: 12px 16px;
        border-radius: 12px;
        border: 0;
        background: var(--accent);
        color: #052e16;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(34, 197, 94, 0.25);
      }

      .admin-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 2000;
      }

      .admin-modal.active {
        opacity: 1;
        pointer-events: all;
      }

      .admin-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(9, 14, 26, 0.72);
        backdrop-filter: blur(8px);
      }

      .admin-modal-window {
        position: relative;
        display: flex;
        flex-direction: column;
        width: min(900px, 90vw);
        max-height: 80vh;
        background: rgba(15, 23, 42, 0.96);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 40px 60px rgba(2, 6, 14, 0.55);
        overflow: hidden;
        z-index: 1;
      }

      .admin-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      }

      .admin-modal-header h2 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .admin-close {
        border: 0;
        background: transparent;
        color: var(--text-soft);
        font-size: 1.2rem;
        cursor: pointer;
      }

      .admin-modal-body {
        display: flex;
        min-height: 400px;
      }

      .admin-sidebar {
        width: 180px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid rgba(148, 163, 184, 0.12);
        background: rgba(9, 14, 26, 0.8);
      }

      .admin-nav-item {
        background: transparent;
        border: 0;
        padding: 14px 18px;
        color: var(--text-soft);
        text-align: left;
        cursor: pointer;
      }

      .admin-nav-item.active {
        background: rgba(59, 130, 246, 0.18);
        color: #bfdbfe;
      }

      .admin-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      .admin-section {
        display: none;
        flex-direction: column;
        gap: 16px;
      }

      .admin-section.active {
        display: flex;
      }

      .admin-hint {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-soft);
      }

      .soundfx-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .soundfx-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
      }

      .soundfx-row label {
        flex: 0 0 160px;
        font-size: 0.85rem;
        color: var(--text-soft);
      }

      .soundfx-row select {
        flex: 1;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(9, 14, 26, 0.8);
        color: var(--text-strong);
      }

      .soundfx-upload {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 1px dashed rgba(148, 163, 184, 0.24);
        border-radius: 12px;
        background: rgba(9, 14, 26, 0.5);
      }

      .soundfx-upload label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--text-soft);
      }

      .soundfx-upload select {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(15, 23, 42, 0.8);
        color: var(--text-strong);
      }

      .soundfx-file {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 8px 14px;
        cursor: pointer;
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-soft);
      }

      .soundfx-file input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .soundfx-upload button {
        padding: 8px 16px;
        border-radius: 10px;
        border: 0;
        background: rgba(34, 197, 94, 0.2);
        color: #bbf7d0;
        cursor: pointer;
      }

      .sleep-toggle {
        font-size: 0.85rem;
        color: var(--text-soft);
      }

      .admin-feedback {
        font-size: 0.8rem;
        min-height: 18px;
        color: var(--accent);
      }

      @media (max-width: 1100px) {
        .app-shell {
          flex-direction: column;
          padding: 24px;
        }
        .control-panel {
          width: 100%;
          flex-direction: row;
          flex-wrap: wrap;
        }
        .control-panel > .skeuo-card {
          flex: 1 1 280px;
        }
      }

      @media (max-width: 768px) {
        .app-shell {
          padding: 20px 16px 40px;
        }
        .chat-area {
          order: -1;
        }
        .control-panel {
          gap: 12px;
        }
        .admin-modal-window {
          width: 94vw;
        }
        .admin-modal-body {
          flex-direction: column;
        }
        .admin-sidebar {
          width: 100%;
          flex-direction: row;
          border-right: 0;
          border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        }
        .admin-nav-item {
          flex: 1;
          text-align: center;
        }
      }
    </style>
  </head>
  <body tabindex="0">
    <div class="app-shell">
      <aside class="control-panel">
        <div class="skeuo-card brand">
          <div>Jarvis Voice Agent</div>
          <span>Console</span>
        </div>

        <div class="skeuo-card">
          <label class="section-title" for="model-select">LLM Model</label>
          <select id="model-select" class="app-select"></select>
        </div>

        <div class="skeuo-card persona-card">
          <label class="section-title">Conversation Persona</label>
          <div class="persona-overview" id="persona-info" style="display:flex;flex-direction:column;gap:6px;">
            <span id="persona-name">Persona: default</span>
            <small id="persona-voice">Voice: male • normal</small>
            <select id="persona-select" class="app-select"></select>
          </div>
        </div>

        <div class="skeuo-card voice-card-stack" id="voice-persona-panel">
          <div class="voice-card" data-persona="male">
            <h3>Male Voice</h3>
            <select class="voice-variant app-select"></select>
            <div class="voice-controls">
              <button type="button" class="btn-preview-en preview-en">Preview EN</button>
              <button type="button" class="btn-preview-hi preview-hi">Preview HI</button>
              <button type="button" class="btn-save-voice save-voice">Save Default</button>
            </div>
          </div>
          <div class="voice-card" data-persona="female">
            <h3>Female Voice</h3>
            <select class="voice-variant app-select"></select>
            <div class="voice-controls">
              <button type="button" class="btn-preview-en preview-en">Preview EN</button>
              <button type="button" class="btn-preview-hi preview-hi">Preview HI</button>
              <button type="button" class="btn-save-voice save-voice">Save Default</button>
            </div>
          </div>
        </div>

        <div class="skeuo-card agent-monitor">
          <label class="section-title">LLM Agent Steps</label>
          <ul class="agent-steps" id="agent-steps"></ul>
        </div>

        <div class="skeuo-card system-usage">
          <label class="section-title">System Usage</label>
          <div class="pill-row" id="system-pills"></div>
        </div>

        <div class="skeuo-card tts-history">
          <label class="section-title">TTS Sessions</label>
          <div id="tts-history" style="display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto;"></div>
          <button type="button" id="refresh-tts" style="align-self:flex-start;background:rgba(59,130,246,0.2);color:#bfdbfe;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;">Refresh</button>
        </div>
      </aside>

      <main class="chat-area">
        <div class="top-strip">
          <div class="status-pill" id="state">IDLE</div>
          <div class="pill-select" id="asr-pill">
            <select id="asr-select">
              <option value="" disabled selected>Loading…</option>
            </select>
          </div>
          <div class="timer-pill" id="tts-timer">Processing Kokoro: 00:00</div>
          <button type="button" class="admin-button" id="admin-settings">Admin</button>
        </div>

        <section class="ring-section">
          <div class="ring" id="ring">
            <div class="audio-meter">
              <div class="audio-meter-fill" id="audio-meter-fill"></div>
            </div>
          </div>
          <div class="live-transcript" id="live-transcript"></div>
        </section>

      <div class="voice-banner" id="voice-banner">
        <span class="label">Voice Input</span>
        <span id="voice-banner-text">Idle</span>
        <small style="margin-left:auto;color:#cbd5f5;font-size:0.7rem;letter-spacing:0.08em;">Press '/' to push-to-talk</small>
      </div>

        <div class="system-tags" id="system-tags"></div>

        <section class="planner-card skeuo-card" id="calendar-panel">
          <div class="planner-header">
            <div>
              <h2>Day Planner</h2>
              <span class="mode-label">Quiet Mode</span>
            </div>
            <div class="mode-buttons">
              <button type="button" data-mode="speed">Speak</button>
              <button type="button" data-mode="balanced" class="active">Quiet</button>
              <button type="button" data-mode="deep">Silent</button>
            </div>
          </div>
          <div class="whats-next">Waiting for plan…</div>
          <div class="calendar-timeline">
            <p class="empty">No schedule yet. Ask “Plan my day.”</p>
          </div>
          <div class="planner-actions">
            <button type="button" class="apply-plan" disabled>Apply plan</button>
            <button type="button" class="skip-plan" disabled>Skip</button>
            <button type="button" class="edit-plan" disabled>Edit</button>
          </div>
          <p class="planner-privacy">Captured screens stay on this Mac. Jarvis only reads them locally.</p>
        </section>

        <section class="chat-panel skeuo-card">
          <div class="chat-log" id="chat-log">
            <div class="chat-empty" id="chat-empty">Start a quick text chat or use the wake word.</div>
          </div>
          <form class="chat-form" id="chat-form">
            <input id="chat-input" type="text" autocomplete="off" placeholder="Type a message" />
            <button type="submit">Send</button>
          </form>
        </section>
      </main>
    </div>

    <div class="admin-modal" id="admin-modal" aria-hidden="true">
      <div class="admin-modal-backdrop" id="admin-backdrop"></div>
      <div class="admin-modal-window">
        <div class="admin-modal-header">
          <h2>Admin Settings</h2>
          <button type="button" class="admin-close" id="admin-close">&times;</button>
        </div>
        <div class="admin-modal-body">
          <nav class="admin-sidebar">
            <button type="button" class="admin-nav-item active" data-section="soundfx">Sound Effects</button>
          </nav>
          <section class="admin-content">
            <div class="admin-section active" data-section="soundfx">
              <h3>Sound Effects</h3>
              <p class="admin-hint">Assign audio cues for wake word, boot sequence, and system states.</p>
              <div class="soundfx-list" id="soundfx-list"></div>
              <form id="soundfx-upload" class="soundfx-upload">
                <label>
                  Event
                  <select id="soundfx-upload-event"></select>
                </label>
                <label class="soundfx-file">
                  <span>Choose audio</span>
                  <input type="file" id="soundfx-file" accept="audio/*" />
                </label>
                <button type="submit">Upload</button>
              </form>
              <div class="sleep-toggle">
                <label><input type="checkbox" id="sleep-toggle" /> Sleep Mode</label>
              </div>
              <div class="admin-feedback" id="admin-feedback"></div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const MODE_LABELS = { speed: "Speak Mode", balanced: "Quiet Mode", deep: "Silent Mode" };
        class CalendarPanel {
          constructor(root) {
            this.root = root;
            this.modeButtonRow = root.querySelector(".mode-buttons");
            this.timeline = root.querySelector(".calendar-timeline");
            this.nextBar = root.querySelector(".whats-next");
            this.actions = Array.from(root.querySelectorAll(".planner-actions button"));
          }
          setMode(mode) {
            if (!this.modeButtonRow) return;
            this.modeButtonRow.querySelectorAll("button").forEach((btn) => {
              const active = btn.dataset.mode === mode;
              btn.classList.toggle("active", active);
              btn.setAttribute("aria-pressed", active ? "true" : "false");
            });
            const label = MODE_LABELS[mode] || mode;
            this.root.querySelector(".mode-label").textContent = label;
          }
          updatePlan(plan) {
            if (!plan) return;
            this.setMode(plan.mode || "balanced");
            this._renderTimeline(plan.blocks || []);
            this._renderNext(plan.blocks || []);
          }
          _renderTimeline(blocks) {
            if (!this.timeline) return;
            this.timeline.innerHTML = "";
            this.actions.forEach((btn) => { btn.disabled = !blocks.length; });
            if (!blocks.length) {
              this.timeline.innerHTML = `<p class="empty">No events yet. Ask “Plan my day”.</p>`;
              return;
            }
            blocks.forEach((block) => {
              const el = document.createElement("div");
              el.className = `timeline-block ${block.type}`;
              el.innerHTML = `
                <div class="time">${formatTime(block.start)} – ${formatTime(block.end)}</div>
                <div class="title">${block.label}</div>
                <div class="meta">${formatMeta(block)}</div>
              `;
              this.timeline.appendChild(el);
            });
          }
          _renderNext(blocks) {
            if (!this.nextBar) return;
            const now = Date.now();
            const upcoming = blocks
              .map((b) => ({ ...b, startTs: Date.parse(b.start || "") }))
              .filter((b) => !Number.isNaN(b.startTs) && b.startTs >= now)
              .sort((a, b) => a.startTs - b.startTs)[0];
            if (!upcoming) { this.nextBar.textContent = "Nothing scheduled. Enjoy the open space."; return; }
            const start = formatTime(upcoming.start);
            this.nextBar.textContent = `${start} — ${upcoming.label}`;
          }
        }
        function formatTime(v){ if(!v) return "--"; const d=new Date(v); return Number.isNaN(d.getTime())?"--":d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}); }
        function formatMeta(b){ if(b.type==="event"&&b.meta?.location) return b.meta.location; if(b.type==="focus"&&b.meta?.list) return `List: ${b.meta.list}`; if(b.type==="prep") return "Prep buffer"; return ""; }
        window.CalendarPanel = CalendarPanel;
      })();
    </script>
    <script>
      const stateEl = document.getElementById("state");
      const ringEl = document.getElementById("ring");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatLog = document.getElementById("chat-log");
      const chatEmpty = document.getElementById("chat-empty");
      const personaNameEl = document.getElementById("persona-name");
      const personaVoiceEl = document.getElementById("persona-voice");
      const personaSelect = document.getElementById("persona-select");
      const voicePanel = document.getElementById("voice-persona-panel");
      const voiceCards = Array.from(voicePanel ? voicePanel.querySelectorAll(".voice-card") : []);
      const voicePreviewAudio = new Audio();
      const asrEl = document.getElementById("state"); // fallback for ASR status via state pill subtitle
      const audioMeterFill = document.getElementById("audio-meter-fill");
      const liveTranscriptEl = document.getElementById("live-transcript");
      const ttsTimerEl = document.getElementById("tts-timer");
      const voiceBannerText = document.getElementById("voice-banner-text");
      const systemTagsEl = document.getElementById("system-tags");
      const systemPillsEl = document.getElementById("system-pills");
      const agentStepsEl = document.getElementById("agent-steps");
      const refreshTtsBtn = document.getElementById("refresh-tts");
      const ttsHistoryEl = document.getElementById("tts-history");
      const modelSelect = document.getElementById("model-select");
      const asrSelect = document.getElementById("asr-select");
      const adminBtn = document.getElementById("admin-settings");
      const adminModal = document.getElementById("admin-modal");
      const adminBackdrop = document.getElementById("admin-backdrop");
      const adminClose = document.getElementById("admin-close");
      const soundfxListEl = document.getElementById("soundfx-list");
      const soundfxUploadForm = document.getElementById("soundfx-upload");
      const soundfxUploadEvent = document.getElementById("soundfx-upload-event");
      const soundfxFileInput = document.getElementById("soundfx-file");
      const adminFeedback = document.getElementById("admin-feedback");
      const sleepToggle = document.getElementById("sleep-toggle");
      const calendarPanelRoot = document.getElementById("calendar-panel");
      const calendarPanel = calendarPanelRoot ? new CalendarPanel(calendarPanelRoot) : null;
      const plannerModeButtons = calendarPanelRoot ? Array.from(calendarPanelRoot.querySelectorAll(".mode-buttons button")) : [];

      plannerModeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          if (!mode) return;
          if (calendarPanel) calendarPanel.setMode(mode);
          updateSystemTags({ text: `Planner mode → ${mode}` });
        });
      });

      const SAMPLE_TEXT_EN = "Good morning, this is Creo.";
      const SAMPLE_TEXT_HI = "सुप्रभात, यह क्रेओ बोल रहा है।";
      const energyNormalizer = 2000;
      let manualActive = false;
      let currentPersonaProfile = null;
      let ttsTimer = null;
      let ttsStart = 0;
      const agentSteps = new Map();
      let currentAsrSelection = "auto";
      let asrEngines = [];

      function applyState(state) {
        stateEl.textContent = state;
        ringEl.classList.remove("active", "speaking", "manual");
        if (["LISTENING", "HOTWORD_HEARD", "COMPOSING", "MAINTENANCE"].includes(state)) {
          ringEl.classList.add("active");
        }
        if (state === "SPEAKING") {
          ringEl.classList.add("speaking");
        }
        if (state === "IDLE" && manualActive) {
          ringEl.classList.add("manual");
        }
        if (state === "IDLE" && voiceBannerText) {
          voiceBannerText.textContent = "Idle";
        }
      }

      function appendChatMessage(role, text, personaProfile = null) {
        if (chatEmpty) {
          chatEmpty.remove();
        }
        const wrapper = document.createElement("div");
        wrapper.className = `chat-message ${role}`;

        const label = document.createElement("span");
        if (role === "assistant" && personaProfile) {
          const personaName = personaProfile.name ?? "Creo";
          label.textContent = `Creo (${personaName})`;
        } else {
          label.textContent = role === "user" ? "You" : "Creo";
        }

        const body = document.createElement("p");
        body.textContent = text;

        wrapper.appendChild(label);
        wrapper.appendChild(body);
        if (role === "assistant" && personaProfile) {
          const meta = document.createElement("small");
          const voicePersona = personaProfile.voice_persona ?? "--";
          const voiceVariant = personaProfile.voice_variant ?? "default";
          meta.textContent = `Voice ${voicePersona} • ${voiceVariant}`;
          wrapper.appendChild(meta);
        }
        chatLog.appendChild(wrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function appendVoiceTranscript(text, personaProfile = null) {
        if (!text) return;
        if (chatEmpty) {
          chatEmpty.remove();
        }
        const wrapper = document.createElement("div");
        wrapper.className = "chat-message transcript";

        const label = document.createElement("span");
        label.textContent = "Voice Input";
        const body = document.createElement("p");
        body.textContent = text;

        wrapper.appendChild(label);
        wrapper.appendChild(body);

        if (personaProfile) {
          const meta = document.createElement("small");
          const personaName = personaProfile.name ?? "default";
          const voicePersona = personaProfile.voice_persona ?? "--";
          const voiceVariant = personaProfile.voice_variant ?? "default";
          meta.textContent = `Persona ${personaName} • Voice ${voicePersona} • ${voiceVariant}`;
          wrapper.appendChild(meta);
        }
        chatLog.appendChild(wrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function openAdminModal() {
        if (!adminModal) return;
        adminModal.classList.add("active");
        adminModal.setAttribute("aria-hidden", "false");
        if (adminFeedback) adminFeedback.textContent = "";
      }

      function closeAdminModal() {
        if (!adminModal) return;
        adminModal.classList.remove("active");
        adminModal.setAttribute("aria-hidden", "true");
      }

      function setAdminFeedback(message, isError = false) {
        if (!adminFeedback) return;
        adminFeedback.textContent = message || "";
        adminFeedback.style.color = isError ? "var(--danger)" : "var(--accent)";
      }

      async function refreshSoundEffects() {
        if (!soundfxListEl) return;
        try {
          const res = await fetch("/admin/sfx");
          if (!res.ok) return;
          const data = await res.json();
          renderSoundEffects(data);
        } catch (err) {
          console.warn("soundfx refresh failed", err);
        }
      }

      function renderSoundEffects(payload) {
        if (!soundfxListEl) return;
        const events = Array.isArray(payload?.events) ? payload.events : [];
        soundfxListEl.innerHTML = "";
        events.forEach((evt) => {
          const row = document.createElement("div");
          row.className = "soundfx-row";
          const label = document.createElement("label");
          label.textContent = evt.label || evt.event;
          const select = document.createElement("select");
          const options = Array.isArray(evt.options) ? evt.options : [];
          if (!options.length) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No files";
            select.appendChild(opt);
            select.disabled = true;
          } else {
            options.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              opt.textContent = name;
              select.appendChild(opt);
            });
            if (evt.selected && options.includes(evt.selected)) {
              select.value = evt.selected;
            }
          }
          select.addEventListener("change", async (event) => {
            const fileName = event.target.value;
            if (!fileName) return;
            try {
              const resp = await fetch("/admin/sfx/select", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ event: evt.event, file: fileName }),
              });
              if (!resp.ok) {
                throw new Error(await resp.text());
              }
              setAdminFeedback(`Assigned ${evt.label || evt.event} to ${fileName}`);
            } catch (error) {
              console.warn("soundfx select failed", error);
              setAdminFeedback("Failed to assign sound effect", true);
              await refreshSoundEffects();
            }
          });
          row.appendChild(label);
          row.appendChild(select);
          soundfxListEl.appendChild(row);
        });

        if (soundfxUploadEvent) {
          soundfxUploadEvent.innerHTML = events
            .map((evt) => `<option value="${evt.event}">${evt.label || evt.event}</option>`)
            .join("");
        }
        if (sleepToggle && typeof payload?.sleep === "boolean") {
          sleepToggle.checked = payload.sleep;
        }
      }

      async function loadASROptions() {
        if (!asrSelect) return;
        try {
          const res = await fetch("/asr/options");
          if (!res.ok) return;
          const data = await res.json();
          asrEngines = Array.isArray(data.engines) ? data.engines : [];
          if (!asrEngines.length) {
            asrSelect.innerHTML = '<option value="">No engines</option>';
            asrSelect.disabled = true;
            return;
          }
          asrSelect.disabled = false;
          asrSelect.innerHTML = asrEngines
            .map((engine) => `<option value="${engine}">${engine}</option>`)
            .join("");
          currentAsrSelection = typeof data.selected === "string" ? data.selected : "auto";
          if (!asrEngines.includes(currentAsrSelection)) {
            currentAsrSelection = asrEngines.includes("auto") ? "auto" : asrEngines[0];
          }
          asrSelect.value = currentAsrSelection;
        } catch (err) {
          console.warn("asr options load failed", err);
        }
      }

      function updatePersonaInfo(profile) {
        if (!profile) return;
        currentPersonaProfile = profile;
        if (personaNameEl) {
          personaNameEl.textContent = `Persona: ${profile.name ?? "default"}`;
        }
        if (personaVoiceEl) {
          const vPersona = profile.voice_persona ?? "--";
          const vVariant = profile.voice_variant ?? "default";
          personaVoiceEl.textContent = `Voice: ${vPersona} • ${vVariant}`;
        }
        if (personaSelect && profile?.name) {
          personaSelect.value = String(profile.name);
        }
      }

      function updateAudioMeter(level) {
        if (!audioMeterFill || typeof level !== "number" || Number.isNaN(level)) return;
        const clipped = Math.max(0, Math.min(level / energyNormalizer, 1));
        const scaled = Math.pow(clipped, 0.6);
        audioMeterFill.style.width = `${Math.round(scaled * 100)}%`;
      }

      function setLiveTranscript(text) {
        if (liveTranscriptEl) liveTranscriptEl.textContent = text || "";
        voiceBannerText.textContent = text ? text : "Idle";
      }

      function startTTSTimer() {
        if (!ttsTimerEl) return;
        if (ttsTimer) clearInterval(ttsTimer);
        ttsStart = Date.now();
        ttsTimerEl.textContent = "Processing Kokoro: 00:00";
        ttsTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - ttsStart) / 1000);
          const mm = String(Math.floor(elapsed / 60)).padStart(2, "0");
          const ss = String(elapsed % 60).padStart(2, "0");
          ttsTimerEl.textContent = `Processing Kokoro: ${mm}:${ss}`;
        }, 200);
      }

      function stopTTSTimer(finalSeconds) {
        if (ttsTimer) {
          clearInterval(ttsTimer);
          ttsTimer = null;
        }
        if (!ttsTimerEl) return;
        if (typeof finalSeconds === "number" && !Number.isNaN(finalSeconds)) {
          const mm = String(Math.floor(finalSeconds / 60)).padStart(2, "0");
          const ss = String(Math.floor(finalSeconds % 60)).padStart(2, "0");
          ttsTimerEl.textContent = `Processing Kokoro: ${mm}:${ss}`;
        } else {
          ttsTimerEl.textContent = "Processing Kokoro: 00:00";
        }
      }

      function updateAgentSteps(payload) {
        if (!agentStepsEl) return;
        const { id, name, status, provider } = payload;
        const detail = { ...payload };
        agentSteps.set(id, { name, status, provider, detail });
        while (agentSteps.size > 20) {
          const firstKey = agentSteps.keys().next().value;
          agentSteps.delete(firstKey);
        }
        agentStepsEl.innerHTML = "";
        Array.from(agentSteps.entries())
          .sort((a, b) => a[0] - b[0])
          .forEach(([, step]) => {
            const li = document.createElement("li");
            li.className = "agent-step";
            const title = document.createElement("div");
            title.textContent = `${step.name}${step.provider ? ` • ${step.provider}` : ""}`;
            const status = document.createElement("span");
            status.className = `status status-${step.status}`;
            status.textContent = step.status.toUpperCase();
            li.appendChild(title);
            li.appendChild(status);
            agentStepsEl.appendChild(li);
          });
      }

      function updateSystemPills(payload) {
        if (!systemPillsEl) return;
        const pills = [];
        if (typeof payload.cpu_percent === "number") {
          pills.push(`CPU ${payload.cpu_percent.toFixed(1)}%`);
        }
        if (typeof payload.mem_percent === "number") {
          pills.push(`MEM ${payload.mem_percent.toFixed(1)}%`);
        }
        if (typeof payload.rss_mb === "number") {
          pills.push(`RSS ${payload.rss_mb.toFixed(0)} MB`);
        }
        systemPillsEl.innerHTML = "";
        pills.forEach((text) => {
          const pill = document.createElement("div");
          pill.className = "pill";
          pill.textContent = text;
          systemPillsEl.appendChild(pill);
        });
      }

      function updateSystemTags(payload) {
        if (!systemTagsEl) return;
        if (payload && payload.text) {
          const tag = document.createElement("div");
          tag.className = "pill";
          tag.textContent = payload.text;
          systemTagsEl.prepend(tag);
          while (systemTagsEl.childNodes.length > 6) {
            systemTagsEl.removeChild(systemTagsEl.lastChild);
          }
        }
      }

      async function loadPersonas() {
        try {
          const res = await fetch("/persona/list");
          if (!res.ok) return;
          const data = await res.json();
          const personas = Array.isArray(data.personas) ? data.personas : [];
          if (personaSelect) {
            personaSelect.innerHTML = personas.map((p) => `<option value="${p.name}">${p.name}</option>`).join("");
          }
        } catch (err) {
          console.warn("persona load failed", err);
        }
      }

      async function refreshVoicePanel() {
        try {
          const res = await fetch("/voice/personas");
          if (!res.ok) return;
          const data = await res.json();
          const personas = data.personas || {};
          voiceCards.forEach((card) => {
            const persona = card.dataset.persona;
            const select = card.querySelector(".voice-variant");
            const info = personas?.[persona];
            if (!select || !info) return;
            const variants = Array.isArray(info.variants) ? info.variants : [];
            select.innerHTML = variants.map((v) => `<option value="${v}">${v}</option>`).join("");
            if (info.default_variant && variants.includes(info.default_variant)) {
              select.value = info.default_variant;
            }
          });
        } catch (err) {
          console.warn("voice persona load failed", err);
        }
      }

      async function previewVoiceVariant(persona, variant, sampleText) {
        try {
          const res = await fetch("/api/tts/speak", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ persona, variant, text: sampleText }),
          });
          if (!res.ok) {
            console.warn("preview failed", res.status);
            return;
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          voicePreviewAudio.src = url;
          await voicePreviewAudio.play().catch(() => {});
        } catch (err) {
          console.warn("preview error", err);
        }
      }

      async function saveVoiceDefault(persona, variant) {
        try {
          const res = await fetch("/voice/personas/set-default", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ persona, variant }),
          });
          if (!res.ok) {
            const msg = await res.text();
            appendChatMessage("assistant", `Voice save failed (${res.status}): ${msg}`);
            return;
          }
          appendChatMessage("assistant", `Saved ${persona} voice as ${variant}`);
          await refreshVoicePanel();
        } catch (err) {
          console.warn("voice save error", err);
        }
      }

      async function loadModelOptions() {
        if (!modelSelect) return;
        try {
          const res = await fetch("/llm/provider/options");
          if (!res.ok) return;
          const data = await res.json();
          const providers = Array.isArray(data.providers) ? data.providers : [];
          modelSelect.innerHTML = providers
            .map((provider) => `<option value="${provider}">${provider}</option>`)
            .join("");
          const currentRes = await fetch("/llm/provider");
          if (currentRes.ok) {
            const current = await currentRes.json();
            if (current.provider && providers.includes(current.provider)) {
              modelSelect.value = current.provider;
            }
          }
        } catch (err) {
          console.warn("model list failed", err);
        }
      }

      async function refreshTTSSessions() {
        try {
          const res = await fetch("/tts/sessions");
          if (!res.ok) return;
          const data = await res.json();
          const sessions = Array.isArray(data.sessions) ? data.sessions.slice(-8).reverse() : [];
          ttsHistoryEl.innerHTML = sessions
            .map((s) => {
              const date = new Date(s.timestamp * 1000).toLocaleTimeString();
              const secs = Number(s.duration || 0).toFixed(1);
              return `<div class="pill">${date} • ${s.mode} • ${secs}s</div>`;
            })
            .join("");
        } catch (err) {
          console.warn("tts history load failed", err);
        }
      }

      function callManual(endpoint) {
        return fetch(endpoint, { method: "POST" });
      }

      function handleLLMAgent(payload) {
        updateAgentSteps(payload);
      }

      const ws = new WebSocket(`ws://${location.host}/ws/state`);
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.state && data.state !== "LLM_AGENT") {
          applyState(data.state);
        }

        if (data.payload?.asr_engine) {
          stateEl.textContent = `${data.state} • ${data.payload.asr_engine} (${data.payload.language ?? "--"})`;
          if (currentAsrSelection !== "auto" && asrSelect && asrEngines.includes(data.payload.asr_engine)) {
            asrSelect.value = data.payload.asr_engine;
          }
        }

        if (typeof data.payload?.audio_level === "number") {
          updateAudioMeter(data.payload.audio_level);
        }

        if (data.state === "PERSONA") {
          updatePersonaInfo(data.payload);
          refreshVoicePanel();
        }
        if (data.payload?.persona_profile) {
          updatePersonaInfo(data.payload.persona_profile);
        }

        if (data.state === "PLANNER" || (data.payload && data.payload.plan)) {
          const planPayload = data.payload?.plan ? data.payload.plan : data.payload;
          if (calendarPanel && planPayload) {
            calendarPanel.updatePlan(planPayload);
          }
          const diff = data.payload?.diff;
          if (Array.isArray(diff) && diff.length > 0) {
            updateSystemTags({ text: `Planner updated (+${diff.length})` });
          }
        }

        if (data.state === "HOTWORD_HEARD" && data.payload?.keyword === "manual") {
          manualActive = true;
          ringEl.classList.add("manual");
        }
        if (data.state === "IDLE") {
          manualActive = false;
          ringEl.classList.remove("manual");
        }

        if (data.state === "RESOURCE") {
          updateSystemPills(data.payload ?? {});
          return;
        }

        if (data.state === "LLM_AGENT") {
          handleLLMAgent(data.payload ?? data);
          return;
        }

        if (data.state === "COMPOSING" && data.payload?.transcript) {
          updateSystemTags({ text: data.payload.transcript });
        }

        if (data.payload?.transcript) {
          setLiveTranscript(data.payload.transcript);
          if (data.state === "LISTENING" && data.payload?.is_final) {
            appendVoiceTranscript(data.payload.transcript, data.payload.persona_profile ?? currentPersonaProfile);
          }
        }

        if (data.payload?.tts_status === "starting") {
          startTTSTimer();
        }
        if (data.payload?.tts_status === "complete") {
          const duration = data.payload.tts_duration ?? 0;
          stopTTSTimer(duration);
          refreshTTSSessions();
        }

        if (data.payload?.text && data.state === "SPEAKING") {
          appendChatMessage(
            data.payload?.mode === "text" ? "assistant" : "assistant",
            data.payload.text,
            data.payload.persona ?? currentPersonaProfile,
          );
        }
      };
      ws.onopen = () => console.log("Floating UI connected");
      ws.onclose = () => applyState("IDLE");

      if (personaSelect) {
        loadPersonas();
        personaSelect.addEventListener("change", async (event) => {
          const name = event.target.value;
          try {
            const res = await fetch("/persona/set", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name }),
            });
            if (res.ok) {
              const data = await res.json();
              if (data?.profile) updatePersonaInfo(data.profile);
            }
          } catch (err) {
            console.warn("persona set failed", err);
          }
        });
      }

      refreshVoicePanel();
      voiceCards.forEach((card) => {
        const persona = card.dataset.persona;
        const select = card.querySelector(".voice-variant");
        const previewEn = card.querySelector(".preview-en");
        const previewHi = card.querySelector(".preview-hi");
        const saveBtn = card.querySelector(".save-voice");
        const currentVariant = () => (select ? select.value : null);
        previewEn?.addEventListener("click", () => previewVoiceVariant(persona, currentVariant(), SAMPLE_TEXT_EN));
        previewHi?.addEventListener("click", () => previewVoiceVariant(persona, currentVariant(), SAMPLE_TEXT_HI));
        saveBtn?.addEventListener("click", () => {
          const variant = currentVariant();
          if (variant) saveVoiceDefault(persona, variant);
        });
      });

      loadModelOptions();
      modelSelect.addEventListener("change", async (event) => {
        const provider = event.target.value;
        try {
          const res = await fetch("/llm/provider", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ provider }),
          });
          if (!res.ok) {
            const msg = await res.text();
            appendChatMessage("assistant", `Model switch failed (${res.status}): ${msg}`);
          } else {
            const data = await res.json();
            appendChatMessage("assistant", `Using ${data.provider} for orchestration.`);
          }
        } catch (err) {
          console.warn("model switch failed", err);
        }
      });

      loadASROptions();
      asrSelect?.addEventListener("change", async (event) => {
        const value = event.target.value;
        if (!value) return;
        currentAsrSelection = value;
        try {
          const res = await fetch("/asr/select", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ engine: value }),
          });
          if (!res.ok) {
            const detail = await res.text();
            throw new Error(detail || res.statusText);
          }
          const data = await res.json();
          currentAsrSelection = data.selected || value;
          if (asrSelect) {
            asrSelect.value = currentAsrSelection;
          }
          appendChatMessage("assistant", `Transcription engine set to ${currentAsrSelection}.`);
        } catch (err) {
          console.warn("asr engine change failed", err);
          appendChatMessage("assistant", "Couldn't change transcription engine. Check server logs.");
          await loadASROptions();
        }
      });

      adminBtn?.addEventListener("click", () => {
        openAdminModal();
        refreshSoundEffects();
      });
      adminClose?.addEventListener("click", closeAdminModal);
      adminBackdrop?.addEventListener("click", closeAdminModal);

      soundfxUploadForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!soundfxFileInput || !soundfxFileInput.files || !soundfxFileInput.files[0]) {
          setAdminFeedback("Select an audio file first", true);
          return;
        }
        const form = new FormData();
        form.append("event", soundfxUploadEvent?.value || "wakeword");
        form.append("file", soundfxFileInput.files[0]);
        try {
          const res = await fetch("/admin/sfx/upload", {
            method: "POST",
            body: form,
          });
          if (!res.ok) {
            const detail = await res.text();
            throw new Error(detail || res.statusText);
          }
          const data = await res.json();
          setAdminFeedback(`Uploaded ${data.file} for ${data.event}`);
          soundfxFileInput.value = "";
          await refreshSoundEffects();
        } catch (err) {
          console.warn("soundfx upload failed", err);
          setAdminFeedback("Upload failed", true);
        }
      });

      sleepToggle?.addEventListener("change", async (event) => {
        const enabled = event.target.checked;
        try {
          const res = await fetch("/admin/sleep", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled }),
          });
          if (!res.ok) {
            const detail = await res.text();
            throw new Error(detail || res.statusText);
          }
          const data = await res.json();
          sleepToggle.checked = !!data.sleep;
          setAdminFeedback(data.sleep ? "Sleep mode enabled" : "Sleep mode disabled");
        } catch (err) {
          console.warn("sleep toggle failed", err);
          setAdminFeedback("Couldn't update sleep mode", true);
          sleepToggle.checked = !enabled;
        }
      });

      refreshTTSSessions();
      refreshTtsBtn?.addEventListener("click", refreshTTSSessions);

      chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        appendChatMessage("user", text);
        chatInput.value = "";
        try {
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          if (!response.ok) {
            const detail = await response.text();
            appendChatMessage("assistant", `Error: ${detail || response.status}`);
            return;
          }
          const data = await response.json();
          appendChatMessage("assistant", data.text || "(no response)", currentPersonaProfile);
        } catch (err) {
          console.error(err);
          appendChatMessage("assistant", "Couldn't reach the assistant. Is it running?", currentPersonaProfile);
        }
      });

      ringEl.addEventListener("click", async () => {
        try {
          if (!manualActive) {
            const resp = await callManual("/manual/wake/start");
            if (!resp.ok) throw new Error(`manual start failed ${resp.status}`);
            manualActive = true;
            ringEl.classList.add("manual");
          } else {
            const resp = await callManual("/manual/wake/stop");
            if (!resp.ok) throw new Error(`manual stop failed ${resp.status}`);
            manualActive = false;
            ringEl.classList.remove("manual");
          }
        } catch (err) {
          console.error(err);
          appendChatMessage("assistant", "Manual control failed. Check server logs.");
        }
      });

      document.body.addEventListener("keydown", async (event) => {
        if (event.key === "Escape" && adminModal?.classList.contains("active")) {
          event.preventDefault();
          closeAdminModal();
          return;
        }
        if (event.key.toLowerCase() === "l" && !event.metaKey && !event.ctrlKey) {
          event.preventDefault();
          try {
            const response = await fetch("/asr/toggle-lang", { method: "POST" });
            if (!response.ok) console.warn("toggle-lang failed", response.status);
          } catch (e) {
            console.warn("toggle-lang error", e);
          }
          return;
        }
        if (event.key === "/" && !event.metaKey && !event.ctrlKey && !event.altKey) {
          if (document.activeElement === chatInput) return;
          if (!manualActive) {
            event.preventDefault();
            try {
              const resp = await callManual("/manual/wake/start");
              if (!resp.ok) throw new Error(`manual start failed ${resp.status}`);
              manualActive = true;
              ringEl.classList.add("manual");
            } catch (err) {
              console.error(err);
              appendChatMessage("assistant", "Manual start via '/' failed. Check server logs.");
            }
          }
        }
      });

      document.body.addEventListener("keyup", async (event) => {
        if (event.key === "/" && !event.metaKey && !event.ctrlKey && !event.altKey) {
          if (document.activeElement === chatInput) return;
          if (manualActive) {
            event.preventDefault();
            try {
              const resp = await callManual("/manual/wake/stop");
              if (!resp.ok) throw new Error(`manual stop failed ${resp.status}`);
              manualActive = false;
              ringEl.classList.remove("manual");
            } catch (err) {
              console.error(err);
              appendChatMessage("assistant", "Manual stop via '/' failed. Check server logs.");
            }
          }
        }
      });

      window.addEventListener("load", () => {
        document.body.focus();
      });
    </script>
  </body>
</html>
